<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="map[]" />
    <meta name="description" content="A Pentester&#39;s Blog">
    <link rel="shortcut icon" type="image/x-icon" href="https://sikkis.github.io/img/favicon.ico">
    <title>Pentest Cypurs 3.0</title>
    <meta name="generator" content="Hugo 0.30.2" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://sikkis.github.io/css/main.css" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old" />
    
    <!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
			<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->

    
  </head>

  <body>
    <div id="wrap">

      
      <nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="https://sikkis.github.io/"><i class="fa fa-home"></i></a>
    </div>
    <div id="navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
        <li><a href="/blog/">BLOG</a></li>
        
      
      </ul>
    </div>
  </div>
</nav>

      
      <div class="container">
        <div class="blog-post">
          <h3>
            <strong><a href="https://sikkis.github.io/blog/pentestcypurs3.0/">Pentest Cypurs 3.0</a></strong>
          </h3>
        </div>
        <div class="blog-title">
          <h4>
          November 18, 2017
            &nbsp;&nbsp;
            
          </h4>
        </div>
        <div class="panel panel-default">
          <div class="panel-body">
            <div class="blogpost">
              

<h1 id="pentest-cyprus-ctf-writeup">Pentest Cyprus CTF Writeup</h1>

<p>This is the 3rd time <strong>Pentest Cyprus</strong> has hosted an event in Cyprus. The event was hosted locally on 2017-10-08 but now it is available for anyone to participate! The CTF can be accessed  <a href="https://gameboard.pentestcyprus.org/">here</a>.</p>

<p>FYI this is my first blog post and CTF Writeup so if something is not accurate or you want to give me some advice please contact me and give me your feedback. I hope you enjoy it!</p>

<hr />

<h1 id="challenges">Challenges:</h1>

<ol>
<li><a href="#f0rest">Miscellaneous | f0rest</a></li>
<li><a href="#r3c_data">Crypto | r3c_data</a></li>
<li><a href="#rsa_tr0ubles">Crypto | rsa_tr0ubles</a></li>
<li><a href="#h4lf_h4lf">Forensics | h4lf_h4lf</a></li>
<li><a href="#cl3ar_keys">Forensics | cl3ar_keys</a></li>
<li><a href="#d1sk_extr4ction">Forensics | d1sk_extr4ction</a></li>
<li><a href="#urg3nt_c4ll">Forensics | urg3nt_c4ll</a></li>
</ol>

<hr />

<h1 id="a-name-f0rest-1-f0rest-a"><a name="f0rest">1. f0rest</a></h1>

<p><strong>Category:</strong> Miscellaneous <strong>Difficulty:</strong> Medium</p>

<p><strong>Description:</strong> Eliot found this code left for him form Mr.Robot. We need to discover what it means.</p>

<p>Hint: Huffman was lost in a forest full of trees. Some of them were binary.</p>

<p>nc://challenges.pentestcyprus.org:7000</p>

<p><a href="https://s3.eu-central-1.amazonaws.com/pentestcyprus/misc-2/f0rest.txt">https://s3.eu-central-1.amazonaws.com/pentestcyprus/misc-2/f0rest.txt</a></p>

<p><a href="https://s3.eu-central-1.amazonaws.com/pentestcyprus/misc-2/f0rest.svg">https://s3.eu-central-1.amazonaws.com/pentestcyprus/misc-2/f0rest.svg</a></p>

<h2 id="files-provided">Files provided:</h2>

<p><img src="/img/pentestcyprus/f0rest/f0rest.svg" width=100%>
Code:</p>

<pre><code>0101101101111101011110101100111001010000100011110100101000011111111011011111100111001111110001000110010001110111101011011111011011111111011101000010001110011100111111011101000010110010001110010001100111001111101001111100011110101100111001111101111111100111101000011100111111010111101001111101100100010100111000
</code></pre>

<p>By inspecting the image we can realize that this is an index tree based on the frequency of each hexadecimal characters. We can get the binary interpretation of each character by tracing each value from the top of the tree to the leaves, adding a 0 when you go left and a 1 when you go right. So for example the character <strong>E</strong> will be: left,left,left which is equals to <code>E = 000</code>. We can build a table with this values and decode the secret message!</p>

<h2 id="solution">Solution</h2>

<pre><code class="language-python">from bitarray import bitarray

huffman_dict = {
    'E': bitarray('000'), '0': bitarray('001'), '7':bitarray('01000'), 
    'F': bitarray('01001'),'D': bitarray('01010'),'5': bitarray('010110'),
    'B': bitarray('010111'), '1': bitarray('0110'), '2': bitarray('0111'),
    '9': bitarray('100'), '8': bitarray('1010'),'C': bitarray('10110'),
    'A': bitarray('10111'),'4': bitarray('110'),'3': bitarray('1110'),
    '6': bitarray('1111')

}

dec = bitarray('0101101101111101011110101100111001010000100011110100101000011111111011011111100111001111110001000110010001110111101011011111011011111111011101000010001110011100111111011101000010110010001110010001100111001111101001111100011110101100111001111101111111100111101000011100111111010111101001111101100100010100111000').decode(huffman_dict)
print(dec)
print(''.join(dec)).decode(&quot;hex&quot;)

</code></pre>

<p>We then connect with netcat to the remote host and submit the secret message we got. The Flag will pop right up! ;)</p>

<pre><code class="language-bash">$ root@kali:~/# nc challenges.pentestcyprus.org 7000
Enter the decoded message: The world itself\'s just one big hoax.
pency_3{such_4_hug3_t4sk_with_trees}
</code></pre>

<hr />

<h1 id="a-name-r3c-data-2-r3c-data-a"><a name="r3c_data">2. r3c_data</a></h1>

<p><strong>Category:</strong> Crypto <strong>Difficulty:</strong> Easy</p>

<p><strong>Description:</strong> We have seen this data flowing around but we do not know what is in it.</p>

<p><a href="https://s3.eu-central-1.amazonaws.com/pentestcyprus/crypto-1/r3c_data.txt">https://s3.eu-central-1.amazonaws.com/pentestcyprus/crypto-1/r3c_data.txt</a></p>

<h2 id="solution-1">Solution</h2>

<p>OMG this file is huge! This file look like it contains a big base64 encoded string. When you try to decode it you get another one but this time was smaller in length. Apparently the file was encoded over and over again by a &ldquo;crazy maniac&rdquo;! ;) Pipping the decoding command, the base64 string was getting smaller and smaller and finally it gave us the flag!</p>

<pre><code class="language-bash">$ base64 -d &lt; r3c_data.txt | base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d| base64 -d
pency_3{h1d3_1n_recurs1on_of_64}

</code></pre>

<hr />

<h1 id="a-name-rsa-tr0ubles-3-rsa-tr0ubles-a"><a name="rsa_tr0ubles">3. rsa_tr0ubles</a></h1>

<p><strong>Category:</strong> Crypto <strong>Difficulty:</strong> Hard</p>

<p><strong>Description:</strong> We manage to intercept the algorithm of a communication of E-Corp employees with the main server. Our contacts tell us that this runs from a default user account in a forgotten server. Can you have a look?</p>

<p>nc://challenges.pentestcyprus.org:5000</p>

<p><a href="https://s3.eu-central-1.amazonaws.com/pentestcyprus/crypto-4/rsa_tr0ubl3s.py">https://s3.eu-central-1.amazonaws.com/pentestcyprus/crypto-4/rsa_tr0ubl3s.py</a></p>

<h2 id="solution-2">Solution</h2>

<p>Ok lets start by examining the description! E-Corp employees are using an algorithm to communicate with each other and that is  uses a <em>default user account</em>. By downloading the link we are prompted with the following python code:</p>

<pre><code class="language-python">import random
import os
import base64

from Crypto.PublicKey import RSA 
from Crypto.Signature import PKCS1_v1_5 
from Crypto.Hash import SHA256 

random.seed(os.getuid())

### UTILS
def isPrime(p):
    if(p==2): return True
    if(not(p&amp;1)): return False
    return pow(2,p-1,p)==1


def egcd(a, b):
    x,y, u,v = 0,1, 1,0
    while a != 0:
        q, r = b//a, b%a
        m, n = x-u*q, y-v*q
        b,a, x,y, u,v = a,r, u,v, m,n
        gcd = b
    return gcd, x, y


### MAIN

def getPrime(bits):
    prime = random.getrandbits(bits)
    while not isPrime(prime):
        prime = random.getrandbits(bits)
    return prime


def construct_key(p):
    q = getPrime(1024)
    n = p * q
    e = 65537

    phi = (p - 1) * (q - 1)

    # Compute modular inverse of e
    gcd, a, b = egcd(e, phi)
    d = a

    return RSA.construct((n, long(e), d, p, q))

def verify_signature(rsakey, signature, data):
    signer = PKCS1_v1_5.new(rsakey) 
    digest = SHA256.new() 

    digest.update(base64.b64decode(data))
    if signer.verify(digest, base64.b64decode(signature)):
        return True
    else:
        return False


p = getPrime(512)
indata = raw_input()
signature = raw_input()
key = construct_key(p)
if indata == 'Z2V0X2ZsYWcK' and verify_signature(key, signature, indata):
    with open('flag.txt', 'r') as f:
        print f.read()
else:
    print 'Unverified!!! Administrator has been notified!!!'
</code></pre>

<h2 id="prerequisites">Prerequisites</h2>

<p>This challenge requires  a basic understanding on how the RSA algorithm works. More information can be found in the wikipage: <a href="https://simple.wikipedia.org/wiki/RSA_(algorithm">https://simple.wikipedia.org/wiki/RSA_(algorithm</a>).</p>

<p>Lets start reviewing the code from the main at the bottom!</p>

<pre><code class="language-python">p = getPrime(512)
indata = raw_input()
signature = raw_input()
key = construct_key(p)
if indata == 'Z2V0X2ZsYWcK' and verify_signature(key, signature, indata):
    with open('flag.txt', 'r') as f:
        print f.read()
else:
    print 'Unverified!!! Administrator has been notified!!!'
</code></pre>

<p>We can see that the script is waiting to read from the standard input two variables, <em>indata</em>  and <em>signature</em>. It picks <em>&ldquo;randomly&rdquo;</em> a prime number (more on that later on), constructs the key and signs the <em>indata</em> string. It thens verifies if the indata equals to &lsquo;Z2V0X2ZsYWcK&rsquo; and if the signature is correct. If these conditions are met the flag.txt file is printed in the standard output.</p>

<p>The RSA algorithm uses two randomly large prime numbers for its computations p and q, but in this case it creates the randomness from the uid of the user running the program! From the description we know that the script is running in a remote server on a default user account. Could be root? Lets try! ;)</p>

<p>To export the private key of the root user we just add the exportKey function that generates the key in PEM format and run the program as root.</p>

<pre><code class="language-python">key = construct_key(p)
#New Code - Export Private Key
private_key = key.exportKey(&quot;PEM&quot;)
print private_key 
#######
if indata == 'Z2V0X2ZsYWcK' and verify_signature(key, signature, indata):
</code></pre>

<p>By running the modified script we get the following private key:</p>

<pre><code>-----BEGIN RSA PRIVATE KEY-----
MIIDXgIBAAKBwQCuE4xCLKix8/6PuOEguAW/riumlZKsIUC8ayt/HfZjgI6hTMf2
B9q9ZI7k/MSrHGhulF9FIGg1Drgy9zvVQNVk5G8NApRCgnqJqPt53VGKq2RMk1/e
YzTynuf5ZniGF+t+tx/bKYonPhOYj6wup7/hP+YfmzwcEfbny70P7+9zZEqSLu4K
3Vt7/JO89Yke1PS8g/rAyorMK2HMA3WsJ+1Ssy1Omrkiv9rj83sfxwIfe7oK6cq4
J3l53ZecCd82XOUCAwEAAQKBwBv85pspJQJfkXk4J3IkREBaV4hUGh30xrzEmly4
y4mZ/NSwTKIhBylWRqdIgLJmQeAtmNe7ayXEtRb0qzkRUH3hxBUW1DAYegjuVC8K
nWjiZ5S+LsawhitqMMxWiE+uio0nr7oY7J4nzKqWekPIBsh4xi48fYNCCVEo3CGg
UMWgnL3qh42PRsr1K1SHYVX+C6722cqZpz6GnIsroTcbnDYdAzvqeDcCFAHrUbNz
LXfHzeZ64AXddCfsi8Drc17xwQJBAMnpPr7MCvo2bKElDYQvnGVU/tqgFz5YXNWy
/VWonYMd5q0lEN57LEJ0sglUvFEV56z9ATBbinYvxC1L1ubGU7ECgYEA3LVwHOiX
PFW4a3a3oM/p9diACfjDK2Eqr4TcVcOdkPpYyNavDOcCFbO3lTcrarrvkgBWf1/I
BO2er9ckxZQy5kaCIcjD9uMmIAMSrX6+A3uUQlG6VVP6xVynfNKdgSaM6Z9PhPF7
CTusz+W2OT5Q2q9v/o3CQOJonxiYw6qcLXUCQB7ulKY2LBhY7hthychOYu9DLifg
Dq+GafJzEUxmIHtNwWEVJJhw1j74Ea5MRO1HJc7ik6QM4hFpD+zAiZOhHoECgYAd
6k3W7UPKfsfvcPj0yBmrI/w+3cP+dj4l6jk/OrN5uiUcm9TAR/OFY4WnqQGuhsYA
ISGYRDBFUrvmk5+9VBgOFFKBJ8hAB4vcXO5EK+CvcimnT5KVDDv6UlO1XIrSvZnt
9JT/rQeDOd5zk2w+mA63hX4Fn8tLpiSOI/RY2SAwHQJBAJirZSBlJTmbVN/9syFn
QrB8KbIpvdFqX7Lo+Rbb/Gb/AATwN0O4c2pJyZP75i6tHdUg+d9vr4k7/Qenqyjs
ERw=
-----END RSA PRIVATE KEY-----
</code></pre>

<p>We then save the private key and sign the <em>Z2V0X2ZsYWcK</em> message.</p>

<pre><code class="language-python">def sign_data(private_key, data):
    '''
    param: private_key_loc Path to your private key
    param: package Data to be signed
    return: base64 encoded signature
    '''
    from Crypto.PublicKey import RSA 
    from Crypto.Signature import PKCS1_v1_5 
    from Crypto.Hash import SHA256 
    from base64 import b64encode, b64decode 
    key = open(private_key, &quot;r&quot;).read() 
    rsakey = RSA.importKey(key) 
    signer = PKCS1_v1_5.new(rsakey) 
    digest = SHA256.new() 
    # It's being assumed the data is base64 encoded, so it's decoded before updating the digest 
    digest.update(b64decode(data)) 
    sign = signer.sign(digest) 
    return b64encode(sign)

print sign_data(&quot;private_key&quot;,&quot;Z2V0X2ZsYWcK&quot;)
</code></pre>

<h2 id="rapping-things-up">Rapping things Up!</h2>

<p>Now the only thing left is to connect to the remote server with netcat and submit the two values!</p>

<pre><code class="language-bash">$ ncat challenges.pentestcyprus.org 5000
Z2V0X2ZsYWcK
WtuqKJOuhn59PGGKN3yMHc3N44t3N9G3tgUH84W7WCvSp7cgmZaHxXjuERRTLwDMVx1LRNBPV1jDbytf6GqH+BHgsPLPNISnKxBqRkie6SpI14NATH6cNlb//1JzE9cmgU7NPBc0rbC1AaP3AUWqQXW8kquPfw4Qmg6j33+f+SOGVIRXqLYcoK5dHyadcbs+KLOeyROixX+45l/xbTmM+/TkeF929wVZx6k27qVoaW7Y5eigHPBgbk9zysBnjc4c
pency{r4nd0mness_sh0uld_b3_s3cure}
</code></pre>

<hr />

<h1 id="a-name-h4lf-h4lf-4-h4lf-h4lf-a"><a name="h4lf_h4lf">4. h4lf_h4lf</a></h1>

<p><strong>Category:</strong> Forensics <strong>Difficulty:</strong> Easy</p>

<p><strong>Description:</strong> E-Corp is trying to obfuscated their communications but we know there is something valuable in there.</p>

<p><a href="https://s3.eu-central-1.amazonaws.com/pentestcyprus/forensics-1/h4lf_h4lf.pcap">https://s3.eu-central-1.amazonaws.com/pentestcyprus/forensics-1/h4lf_h4lf.pcap</a></p>

<h2 id="solution-3">Solution</h2>

<p>The competition had a pre defined structure for the flags. If we check the rules section in the website we can see that the format is pency_3{s0mething_s0mething}. When we open the pcap file with Wireshark, we can search the packets for this pattern with the following filter:</p>

<pre><code>data contains &quot;pency&quot;
</code></pre>

<p><img src="/img/pentestcyprus/h4lf_h4lf/data-first-half.png" width=100%></p>

<p>As the name of the challenge implies the message is in two half&rsquo;s! We have to find the other half. The next step is to follow the tcp stream to see if the second part of the flag is there, but it was a dead end.</p>

<p><img src="/img/pentestcyprus/h4lf_h4lf/tcp-stream-6.png" width=100%></p>

<p>Trying to follow the other tcp streams before and after the 6th that contain the first half of the flag does not lead to any clues. But we could just search for the end bracket! Using the same method as before, the second half of the flag is found in a UDP package!</p>

<pre><code>data contains &quot;}&quot;
</code></pre>

<p><img src="/img/pentestcyprus/h4lf_h4lf/udp-stream-second-half.png" width=100%></p>

<p>pency_3{spl1t_iN_tw0_h4lv3s}</p>

<hr />

<h1 id="a-name-cl3ar-keys-5-cl3ar-keys-a"><a name="cl3ar_keys">5. cl3ar_keys</a></h1>

<p><strong>Category:</strong> Forensics <strong>Difficulty:</strong> Easy</p>

<p><strong>Description:</strong> We hijacked some traffic from an E-Corp employee logging in but although it is in clear text something is wrong because we cannot login.</p>

<p>nc://challenges.pentestcyprus.org:3001</p>

<p><a href="https://s3.eu-central-1.amazonaws.com/pentestcyprus/forensics-3/cl3ar_keys.pcap">https://s3.eu-central-1.amazonaws.com/pentestcyprus/forensics-3/cl3ar_keys.pcap</a></p>

<h2 id="solution-4">Solution</h2>

<p>As the description says the file contains the login credentials of an E-Corp employee. By right clicking and following the tcp stream we can see the following credentials:</p>

<p><img src="/img/pentestcyprus/cl3ar_keys/tcp-stream.png" width=100%>
When you try to connect to the remote server with username <code>angel@</code> and password <code>p4l254...!@453.345</code> we can see that the credentials are invalid.</p>

<p>The ASCII representation of the TCP stream is not accurate because in Wireshark all non-printable characters are being replaced by dots. By changing the data output to be presented as hex-dump, each dot between the letters of the password has the value of 0x7F.</p>

<p><img src="/img/pentestcyprus/cl3ar_keys/tcp-stream-hex.png" width=100%></p>

<p>In the ASCII table 0x7F is a non readable character call DEL. So for each one of the dots inside the password we have to delete one of the previous characters! The original password was:<code>p4l254...!@453.345</code>. Removing all the dots and the additional characters we get:<code>p4l!@45345</code>.</p>

<pre><code class="language-bash">$ root@kali:~/# nc challenges.pentestcyprus.org 3001
username &gt;angel@
password &gt;p4l!@45345
pency_3{n0n_vis1bl3_chars_ar3_st1ll_th3re}
</code></pre>

<hr />

<h1 id="a-name-d1sk-extr4ction-6-d1sk-extr4ction-a"><a name="d1sk_extr4ction">6. d1sk_extr4ction</a></h1>

<p><strong>Category:</strong> Forensics <strong>Difficulty:</strong> Medium</p>

<p><strong>Description:</strong> Angela Moss got us an image of a disk partition from the FBI that setup shop in E-Corp. There must be some hints on talking with their main server.
nc://challenges.pentestcyprus.org:3000</p>

<p><a href="https://s3.eu-central-1.amazonaws.com/pentestcyprus/forensics-2/d1sk_extr4ction">https://s3.eu-central-1.amazonaws.com/pentestcyprus/forensics-2/d1sk_extr4ction</a></p>

<h2 id="solution-5">Solution</h2>

<p>Ok so the hardest part was to figure out how to mount this thing! First we run the file command and get the following output:</p>

<pre><code>$file d1sk_extr4ction 
d1sk_extr4ction: DOS/MBR boot sector; partition 1 : ID=0xaf, start-CHS (0x0,32,33), end-CHS (0x1,70,5), startsector 2048, 18432 sectors, extended partition table (last)
</code></pre>

<p>On a standard hard drive one sector is 512 bytes. By multiplying each sectors of the partition with its size we get: 512*2048=1048576 bytes.</p>

<pre><code>$ mount -o loop,offset=1048576 d1sk_extr4ction /tmp/dsk/
</code></pre>

<p>The next step is to identify any interesting files inside this mounted disk which will lead us to the flag. The <em>notes.txt</em> contained a paragraph that looked like the words where scrabbled with some kind of algorithm.</p>

<pre><code>$ cd /tmp/dsk/documents
$ cat notes.txt

OGO A fwwv lg ojalw sdd gx lzak vgof twusmkw lzw mkwj esfmsd ak fgl nwjq zwdhxmd sfv
lzw ymqk lzsl afklsddwv lzw kqklwe sjw fgl nwjq zwdhxmd.

Lg smlzwflauslw lg lzw kwjnwj A xajkl fwwv lg kwfv lzw tqlwk 0p59434550. Lzwq ksav
kgewlzafy stgml sf wfvasf sfv zae twafy dalldw.

Lzwf A oadd tw hjgehlwv oalz s fmetwj. A fwwv lg kwfv tsuc lzsl fmetwj kimsjwv.

Lzwf A oadd tw hjgehlwv oalz s kwugfv fmetwj. A fwwv lg jwlmjf lzw jwkmdl gx 2 lg lzw hgowj gx lzsl fmetwj.
</code></pre>

<p>My first thought was that it may be a substitution cipher in which each letter in the plaintext is replaced by another letter of the alphabet. Trying all the rotations on the Ceasar cipher we can decode it with a shift of 8.</p>

<pre><code>WOW I need to write all of this down because the user manual is not very helpful and
the guys that installed the system are not very helpful.

To authenticate to the server I first need to send the bytes 0x59434550. They said
something about an endian and him being little.

Then I will be prompted with a number. I need to send back that number squared.

Then I will be prompted with a second number. I need to return the result of 2 to the power of that number.
</code></pre>

<p>By reading the instructions we could tell that we have to do 3 things when we connected the remote server
1. Send the 0x59434550 in little endian, which is the reverse of the value provided, 0x50454359 abd last converted to ASCII 0x50454359=PECY
2. Take the number we are given and squared it.
3. Raise the new number to the power of 2.</p>

<pre><code>nc challenges.pentestcyprus.org 3000
PECY
36
1296
8
256
pency_3{w0w_th3_comM_iS Re4l}
</code></pre>

<hr />

<h1 id="a-name-urg3nt-c4ll-7-urg3nt-c4ll-a"><a name="urg3nt_c4ll">7. urg3nt_c4ll</a></h1>

<p><strong>Category:</strong> Forensics <strong>Difficulty:</strong> Hard</p>

<p><strong>Description:</strong> There is some hidden communication in TCP packets that points to the FBI.</p>

<h2 id="solution-6">Solution</h2>

<p>The pcap file contains a tcp connection between two hosts. By right clicking and following the tcp stream we see a strange communication that does not give us much.</p>

<p><img src="/img/pentestcyprus/urg3nt_c4ll/tcp-stream.png" width=100%>
After some time I noticed that some packages had an error message saying that the urgent pointer field is nonzero while the URG flag is not set. When we inspect the TCP header structure we can see that the Urgent Pointer has a length of 2 bytes, when the Urgent flag is set to 0.</p>

<pre><code>    0                   1                   2                   3   
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |          Source Port          |       Destination Port        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                        Sequence Number                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Acknowledgment Number                      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Data |           |U|A|P|R|S|F|                               |
   | Offset| Reserved  |R|C|S|S|Y|I|            Window             |
   |       |           |G|K|H|T|N|N|                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           Checksum            |         Urgent Pointer        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Options                    |    Padding    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                             data                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                            TCP Header Format

          Note that one tick mark represents one bit position.
</code></pre>

<p>We can see all the malformed packages by selecting the Analyse-&gt;Expert Information.
Each second byte of the Urgent Pointer is not set to zero, and falls to the range of the ASCII characters and the first one is the character &ldquo;p&rdquo;. If we scroll in each of the 28 malformed packages we can reconstruct the flag!</p>

<p><img src="/img/pentestcyprus/urg3nt_c4ll/expert-information.png" width=100%></p>

<p>pency_3{h1d3_in_pl41n_s1ght}</p>

<h2 id="extra">Extra</h2>

<p>A big thanks to Marios and Simon from RUNESEC for suggesting to use tshark to extract the urgent pointers!</p>

<pre><code>for i in `tshark -r urg3nt_c4ll.pcap -T fields -e tcp.urgent_pointer`; do echo $(printf \\$(printf '%03o' $i)); done
    
p   
e   
n   
c   
y   
_   
3   
{   
h   
1   
d   
3   
_   
i   
n   
_   
p   
l   
4   
1   
n   
_   
s   
1   
g   
h   
t   
}   
</code></pre>

              <hr>
              <div class="related-posts">
                <h5>Related Posts</h5>
                
              </div>
            </div>
          </div>
          <hr>
        <div class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">

    (function() {
      
      
      if (window.location.hostname == "localhost")
        return;

      var disqus_shortname = 'https-sikkis-github-io';
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
        </div>
      </div>
      
    </div>

    
    <footer>
  <div id="footer">
    <div class="container">
      <p class="text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io/">Hugo</a> and
      <a href="http://www.github.com/nurlansu/hugo-sustain/">sustain</a> with ♥</p>
    </div>
  </div>
</footer>
<div class="footer"></div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://sikkis.github.io/js/docs.min.js"></script>
<script src="https://sikkis.github.io/js/main.js"></script>

<script src="https://sikkis.github.io/js/ie10-viewport-bug-workaround.js"></script>


    
  </body>
</html>
